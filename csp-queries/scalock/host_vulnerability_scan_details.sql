--Host vulnerability scan details
SELECT
   scans.scan_date as scan_date,
   hosts.id::text as host_id,
   hosts.logicalname::text as host_full_name,
   split_part(hosts.logicalname, '.', 1) as host_short_name,
   scans.crit_vulns as host_critical_vulns,
   scans.high_vulns as host_high_vulns,
   scans.med_vulns as host_med_vulns,
   scans.low_vulns as host_low_vulns,
   scans.neg_vulns as host_neg_vulns,
   scans.crit_vulns + scans.high_vulns + scans.med_vulns + scans.low_vulns + scans.neg_vulns as host_total_vulns,
   scans.id as scan_id,
   kr.type as resource_type,
   kr.format as resource_format,
   kr.name as resource_name,
   kr.version as resource_version,
   krv.name as vuln_id,
   CASE
        WHEN krv.vendor_cvss3_score > 0 THEN krv.vendor_cvss3_score 
        WHEN krv.nvd_cvss3_score > 0 AND krv.vendor_severity = '' THEN krv.nvd_cvss3_score 
        WHEN krv.vendor_cvss2_score > 0 THEN krv.vendor_cvss2_score
        WHEN krv.vendor_severity = '' THEN krv.nvd_cvss2_score 
        ELSE 0
  END as vuln_score,
  CASE
        WHEN cast(krv.nvd_cvss3_severity as text) != '' AND cast(krv.vendor_severity as text) = '' THEN cast(krv.nvd_cvss3_severity as text)
        ELSE public.aqua_severity((select r from public.known_resource_vulnerabilities r where id=krv.id), true)	
  END as vuln_severity,
  TO_DATE (krv.publish_date,'YYYY-MM-DD') as vuln_publish_date,
  CAST(krv.created as date) as vuln_first_seen_date
FROM scans
JOIN hosts ON scans.host_id = hosts.id
JOIN scan_resources sr ON scans.id = sr.scan_id
JOIN known_resources kr ON sr.resource_id = kr.id
JOIN known_resource_vulnerabilities krv ON sr.resource_id = krv.resource_id
WHERE krv.issue_type = 'vulnerability' AND scans.type='host' 
