--Host vulnerability scan details
SELECT
   scans.scan_date AS scan_date,
   hosts.id::text AS host_id,
   hosts.logicalname::text AS host_full_name,
   split_part(hosts.logicalname, '.', 1) AS host_short_name,
   scans.crit_vulns AS host_critical_vulns,
   scans.high_vulns AS host_high_vulns,
   scans.med_vulns AS host_med_vulns,
   scans.low_vulns AS host_low_vulns,
   scans.neg_vulns AS host_neg_vulns,
   scans.crit_vulns + scans.high_vulns + scans.med_vulns + scans.low_vulns + scans.neg_vulns AS host_total_vulns,
   scans.id AS scan_id,
   kr.type AS resource_type,
   kr.format AS resource_format,
   kr.name AS resource_name,
   kr.version AS resource_version,
   krv.name AS vuln_id,
   CASE
        WHEN krv.vendor_cvss3_score > 0 THEN krv.vendor_cvss3_score 
        WHEN krv.nvd_cvss3_score > 0 AND krv.vendor_severity = '' THEN krv.nvd_cvss3_score 
        WHEN krv.vendor_cvss2_score > 0 THEN krv.vendor_cvss2_score
        WHEN krv.vendor_severity = '' THEN krv.nvd_cvss2_score 
        ELSE 0
   END AS vuln_score,
   CASE
        WHEN CAST(krv.nvd_cvss3_severity AS text) != '' AND CAST(krv.vendor_severity AS text) = '' THEN CAST(krv.nvd_cvss3_severity AS text)
        ELSE public.aqua_severity((SELECT r FROM public.known_resource_vulnerabilities r WHERE id=krv.id), true)	
   END AS vuln_severity,
   CASE WHEN krv.publish_date ~ '^\\d{4}-\\d{2}-\\d{2}$'
        THEN TO_DATE(krv.publish_date::text, 'YYYY-MM-DD')
        ELSE NULL
   END AS vuln_publish_date,
   CASE WHEN krv.created::text ~ '^\\d{4}-\\d{2}-\\d{2}$'
        THEN TO_DATE(krv.created::text, 'YYYY-MM-DD')
        ELSE NULL
   END AS vuln_first_seen_date
FROM scans
JOIN hosts ON scans.host_id = hosts.id
JOIN scan_resources sr ON scans.id = sr.scan_id
JOIN known_resources kr ON sr.resource_id = kr.id
JOIN known_resource_vulnerabilities krv ON sr.resource_id = krv.resource_id
WHERE krv.issue_type = 'vulnerability' AND scans.type = 'host';
